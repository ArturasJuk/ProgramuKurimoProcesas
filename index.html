<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	</head>
	
	<body>
		<div class="text-center jumbotron">
		<h1>Joomla dead-link finderis </h1>
		</div>
		
		<div class="text-center jumbotron">		
				<div class="input-group col-lg-4 col-lg-offset-4">
					<input type="text" class="form-control" placeholder="Saitas" id="saitas">
				</div>
				<br>
				<button type="button" class="btn btn-primary" onclick="startDFS()">Ie≈°koti</button>
		</div>
		
		<div class="text-center jumbotron">		
			<table id="rasti" class="table table-primary text-center table-striped">
					<thead calss="text-center">
					 <tr>
					  <th scope="col" class="text-center">Linkas</th>
					  <th scope="col" class="text-center">Rastas</th>
					  <th scope="col" class="text-center">HTTP kodas</th>
					 </tr>
				  </thead>
				  <tbody>
			</table>
		</div>
	</body>
	
	<script>
	
		const proxy = '';//'https://cors-anywhere.herokuapp.com/';
		const table = document.getElementById("rasti");
		let home = "home";
		let visited = {};
		let Q = [];
		
		const DFS = () => 
		{
				if(Q.length <= 0)return;
				let cur = Q.pop();
				let url = cur[0];
				fromWhere = cur[1];
				console.log(url);
				
				fetch(proxy+url)
				.then(response => {
					if(response.status >= 400)
					{
						const row = table.insertRow(1);
						const deadLink = row.insertCell(0);
						const kurRastas = row.insertCell(1);
						const HTTPKodas = row.insertCell(2);
						
						deadLink.textContent = url;
						kurRastas.textContent = fromWhere;
						HTTPKodas.textContent = response.status;
						row.classList.add("bg-danger");
					}
					
					if(url.search(home)!=-1)
					return response.text();
					return "";
					
				}).then(text => {

						let urlRegex = /(http|ftp|https):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])?/g;
						let links = text.match(urlRegex);
						let relativeUrlRegex = /(href|src)="\/[a-zA-Z.\/0-9\-]+"/g;
						let relativeLinks = text.match(relativeUrlRegex);
						
						if(relativeLinks==null)relativeLinks=[];
						if(links==null)links=[];
						
						console.log(links);
						console.log(relativeLinks);
						
						links.forEach(link =>
						{
							console.log(link);
							if(!visited.hasOwnProperty(url+">>"+link))
							{
								visited[url+">>"+link]=1;
								Q.push([link,url]);
							}
						});
						
						relativeLinks.forEach(link =>
						{
							let realLink = home + link.replace('href="','').replace('src="','').replace('"','');
							if(!visited.hasOwnProperty(url+">>"+realLink))
							{
								visited[url+">>"+realLink]=1;
								Q.push([realLink,url]);
							}
						});
						
					return;
				}).catch(error => 
				{
						const row = table.insertRow(1);
						const deadLink = row.insertCell(0);
						const kurRastas = row.insertCell(1);
						const HTTPKodas = row.insertCell(2);
						
						deadLink.textContent = url;
						kurRastas.textContent = fromWhere;
						HTTPKodas.textContent = error;
						row.classList.add("bg-danger");
				});
		}
		const startDFS = () => 
		{
			home = document.getElementById("saitas").value;
			Q.push([home,home]);
			visited[home+">>"+home]=1;
			setInterval(DFS,250);
		}
	</script>
<html>